#!/bin/bash
# WireGuard quick setup script for {{ node_name }}
# Generated by WireGuard Mesh Generator

set -e

INTERFACE_NAME="{{ node_name }}"
CONFIG_FILE="/etc/wireguard/${INTERFACE_NAME}.conf"

# Function to start WireGuard
start_wireguard() {
    echo "Starting WireGuard interface: $INTERFACE_NAME"
    wg-quick up "$INTERFACE_NAME"
    echo "WireGuard interface $INTERFACE_NAME started successfully"
}

# Function to stop WireGuard
stop_wireguard() {
    echo "Stopping WireGuard interface: $INTERFACE_NAME"
    wg-quick down "$INTERFACE_NAME" || true
    echo "WireGuard interface $INTERFACE_NAME stopped"
}

# Function to restart WireGuard
restart_wireguard() {
    stop_wireguard
    sleep 1
    start_wireguard
}

# Function to show status
show_status() {
    echo "WireGuard interface status:"
    wg show "$INTERFACE_NAME" || echo "Interface $INTERFACE_NAME is not active"
}

# Function to install configuration
install_config() {
    echo "Installing WireGuard configuration..."
    
    # Create WireGuard directory if it doesn't exist
    sudo mkdir -p /etc/wireguard
    
    # Copy configuration file
    sudo cp "{{ node_name }}.conf" "$CONFIG_FILE"
    sudo chmod 600 "$CONFIG_FILE"
    
    echo "Configuration installed to $CONFIG_FILE"
}

# Main script logic
case "${1:-}" in
    start)
        start_wireguard
        ;;
    stop)
        stop_wireguard
        ;;
    restart)
        restart_wireguard
        ;;
    status)
        show_status
        ;;
    install)
        install_config
        ;;
    *)
        echo "Usage: $0 {start|stop|restart|status|install}"
        echo ""
        echo "Commands:"
        echo "  start    - Start the WireGuard interface"
        echo "  stop     - Stop the WireGuard interface"
        echo "  restart  - Restart the WireGuard interface"
        echo "  status   - Show interface status"
        echo "  install  - Install configuration to /etc/wireguard/"
        exit 1
        ;;
esac
